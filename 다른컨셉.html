<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í•œêµ­ê¸°ë…êµì¥ë¡œíšŒ í•´ì™¸ ì„ êµë™ì—­ì ì§€ë„ (í†µí•© ì•ˆì •í™”)</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <style>
        /* ì „ì²´ ìŠ¤íƒ€ì¼ì€ ê¸°ì¤€ ì½”ë“œì™€ ì™„ì „íˆ ë™ì¼í•˜ë©°,
           ë‰´ìŠ¤ë ˆí„° ì˜¤ë²„ë ˆì´ ê´€ë ¨ ìŠ¤íƒ€ì¼ì´ ì•„ë˜ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤ */
        body { margin: 0; font-family: sans-serif; }
        /* ... (ì¤‘ëµ: ê¸°ì¡´ ìŠ¤íƒ€ì¼ë“¤ ê·¸ëŒ€ë¡œ ë³µì‚¬) ... */

        /* ë‰´ìŠ¤ë ˆí„° ì˜¤ë²„ë ˆì´ */
        #newsletter-overlay {
            position: fixed; left: 0; top: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.86);
            z-index: 9999;
            display: flex; align-items: center; justify-content: center;
        }
        #newsletter-content {
            background: #fff; border-radius: 14px; max-width: 96vw; max-height: 92vh;
            box-shadow: 0 4px 32px #0008;
            position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 2vw;
        }
        #newsletter-close-btn {
            position: absolute; top: 12px; right: 18px;
            background: #fff; color: #222;
            border: none; border-radius: 50%; width: 38px; height: 38px;
            font-size: 1.9em; cursor: pointer; z-index: 2;
            box-shadow: 0 2px 7px #9992;
            display: flex; align-items: center; justify-content: center;
            transition: background 0.2s;
        }
        #newsletter-close-btn:hover { background: #ffe4e4; }
        #newsletter-content iframe, #newsletter-content img, #newsletter-content video {
            max-width: 90vw; max-height: 78vh; border-radius: 12px; background: #222;
            display: block;
        }
        .prayer-link {
            color: #156de4; text-decoration: underline; cursor: pointer; font-weight: bold;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="detailPopup" class="detail-popup"></div>
    <h1 class="top-title">
        <img src="logo.svg" alt="ì• ë‹ˆë©”ì´ì…˜ ON/OFF" class="title-logo" id="titleLogo">
        í•œêµ­ê¸°ë…êµì¥ë¡œíšŒ í•´ì™¸ ì„ êµë™ì—­ì ì§€ë„
    </h1>
    <div class="missionary-tables-row">
        <div id="missionary-table-country" class="country-table-overlay"></div>
        <div id="missionary-table-presbytery" class="presbytery-table-overlay"></div>
    </div>
    <div id="fullscreenBtn" class="fullscreen-btn" title="ì „ì²´í™”ë©´ ë³´ê¸°">ğŸ–µ</div>
    <div id="exitFullscreenBtn" class="fullscreen-btn hidden" title="ì „ì²´í™”ë©´ ì¢…ë£Œ">âœ–</div>
    <div id="country-exit-btn">Ã—</div>
    <div class="footer-banner">
        ì´ ì§€ë„ëŠ” ì „ì„¸ê³„ì— í©ì–´ì ¸ ì„ êµì‚¬ì—­ì„ ê°ë‹¹í•˜ê³  ìˆëŠ” ì´íšŒíŒŒì†¡ í•´ì™¸ì„ êµë™ì—­ìë‹˜ë“¤ì˜ í˜„í™©ì„ ì‹œê°ì ìœ¼ë¡œ ë³´ì—¬ì¤ë‹ˆë‹¤.<br>
        ê·€í•œ ì„ êµì‚¬ì—­ì„ ìœ„í•´ ê¸°ë„ë¡œ í•¨ê»˜ í•˜ì—¬ ì£¼ì‹œê¸°ë¥¼ ë¶€íƒë“œë¦½ë‹ˆë‹¤.
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const MissionaryMap = {
        // ìƒíƒœ, ì„¤ì •, ì´ˆê¸°í™” ë¡œì§ì€ ê¸°ì¤€ ì½”ë“œì™€ 100% ë™ì¼
        state: { /* ... */ },
        elements: { /* ... */ },
        map: null,
        globalMarkers: [],
        fixedCountryMarkers: [],
        fixedCountryPopups: [],
        timers: {},
        constants: { /* ... */ },

        getLatLng(item, country) { /* ... */ },

        init() {
            this.initMap();
            this.initEventListeners();
            this.fetchData();
        },
        initMap() { /* ... */ },
        initEventListeners() { /* ... */ },
        fetchData() { /* ... */ },
        processData(data) { /* ... */ },
        renderAll() { /* ... */ },
        startIntervals() { /* ... */ },
        renderCountryTable() { /* ... */ },
        renderPresbyteryTable() { /* ... */ },
        renderGlobalMarkers() { /* ... */ },

        showDetailPopup(name, latlng) {
            const info = this.state.missionaryInfo[name] || {};
            const sentYear = info.sent_date ? new Date(info.sent_date).getFullYear() : 'ì •ë³´ ì—†ìŒ';
            const imgSrc = info.image?.trim() || "https://via.placeholder.com/320x180.png?text=No+Photo";
            const newsUrl = info.NewsLetter?.trim() || '';
            let prayerHtml = info.prayer || 'í˜„ì§€ ì •ì°©ê³¼ ê±´ê°•';
            if (newsUrl) {
                prayerHtml = `<span class="prayer-link" onclick="window.MissionaryMap.showNewsletter('${encodeURIComponent(newsUrl)}');event.stopPropagation();">${prayerHtml}</span>`;
            }
            this.elements.detailPopup.innerHTML = `
                <div class="close-btn">âœ–</div>
                <div class="popup-img-area"><img src="${imgSrc}" alt="${name}" loading="lazy" onerror="this.onerror=null;this.src='https://via.placeholder.com/320x180.png?text=No+Photo';"></div>
                <h3 style="margin-top:10px;">${name}</h3>
                <p><strong>íŒŒì†¡ë…„ë„:</strong> ${sentYear}ë…„</p>
                <p><strong>ì†Œì†:</strong> ${info.organization || 'ì •ë³´ ì—†ìŒ'}</p>
                <p><strong>ê¸°ë„ì œëª©:</strong> ${prayerHtml}</p>
            `;
            this.positionPopupCentered();
            this.state.isPaused = true;
        },
        positionPopupCentered() {
            setTimeout(() => {
                const popup = this.elements.detailPopup;
                const mapRect = this.elements.mapContainer.getBoundingClientRect();
                const popupRect = popup.getBoundingClientRect();
                let x = mapRect.left + (mapRect.width - popupRect.width) / 2;
                let y = mapRect.top + (mapRect.height - popupRect.height) / 2;
                if (window.innerWidth < 700) {
                    x = (window.innerWidth - popupRect.width) / 2;
                    y = (window.innerHeight - popupRect.height) / 2;
                }
                popup.style.left = `${Math.max(10, x)}px`;
                popup.style.top = `${Math.max(10, y)}px`;
                popup.classList.add('visible');
                popup.style.display = 'block';
            }, 16);
        },
        closeDetailPopup() {
            const popup = this.elements.detailPopup;
            popup.classList.remove('visible');
            popup.style.display = 'none';
            this.state.isPaused = false;
        },

        // (í”Œë¡œíŒ…, êµ­ê°€ê³ ì •, ë…¸íšŒíŒì—…, ìë™íšŒì „ ë“± ë‚´ìš© ë™ì¼)

        showNewsletter(newsletterUrlEncoded) {
            const url = decodeURIComponent(newsletterUrlEncoded);
            document.getElementById('newsletter-overlay')?.remove();
            const overlay = document.createElement('div');
            overlay.id = 'newsletter-overlay';
            overlay.innerHTML = `
                <div id="newsletter-content">
                    <button id="newsletter-close-btn" title="ë‹«ê¸°">âœ–</button>
                    <div id="newsletter-media-area"></div>
                </div>`;
            document.body.appendChild(overlay);
            const area = overlay.querySelector('#newsletter-media-area');
            if (url.match(/\.(pdf)$/i)) {
                area.innerHTML = `
                    <iframe src="https://mozilla.github.io/pdf.js/web/viewer.html?file=${encodeURIComponent(url)}"
                            style="width:90vw;height:75vh;" frameborder="0" allowfullscreen></iframe>
                    <div style="font-size:0.95em; color:#777; margin-top:6px;">
                        PDFê°€ ì •ìƒí‘œì‹œ ì•ˆë  ê²½ìš°
                        <a href="${url}" target="_blank" style="color:#1574d4;text-decoration:underline;">ìƒˆ ì°½</a>
                    </div>`;
            } else if (url.match(/\.(jpe?g|png|gif|webp)$/i)) {
                area.innerHTML = `<img src="${url}" alt="ë‰´ìŠ¤ë ˆí„° ì´ë¯¸ì§€" style="max-width:90vw;max-height:75vh;">`;
            } else if (url.match(/\.(mp4|webm|mov)$/i)) {
                area.innerHTML = `<video src="${url}" controls autoplay style="max-width:90vw;max-height:75vh;"></video>`;
            } else {
                area.innerHTML = `
                    <iframe src="${url}" style="width:80vw;height:78vh;border:none;" allow="autoplay; fullscreen"></iframe>
                    <div style="font-size:0.98em; color:#777; margin-top:8px;">
                        PDF/ì´ë¯¸ì§€/ì˜ìƒ ë¯¸í‘œì‹œ ì‹œ
                        <a href="${url}" target="_blank" style="color:#1374e7;text-decoration:underline;">ìƒˆ ì°½</a>
                    </div>`;
            }
            overlay.querySelector('#newsletter-close-btn').onclick = () => overlay.remove();
            overlay.onclick = e => { if (e.target === overlay) overlay.remove(); };
        }
        // â€¦ ê·¸ ì™¸ ê¸°ì¡´ ë©”ì„œë“œë„ ë™ì¼í•˜ê²Œ í¬í•¨ â€¦
    };

    MissionaryMap.init();
    window.MissionaryMap = MissionaryMap;
});
</script>
</body>
</html>
